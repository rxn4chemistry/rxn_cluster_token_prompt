from typing import Tuple

import click
import pandas as pd
import os

@click.command()
@click.argument('input_csv_file', type=click.Path(exists=True), required=True)
@click.argument('output_path', type=click.Path(exists=True), required=True)
@click.option('--seed', multiple=True, type=int)
@click.option('--split_ratio', default=0.1, type=float)
def main(input_csv_file: str,
         output_path: str,
         seed: Tuple[int],
         split_ratio: float):
    """
    Script to generate multiple random splits for a dataset

    Parameters
    ----------
    input_csv_file: a csv file containing at least the reaction smiles
    output_path: where to store the output files
    seed: the seeds used for generating the splits. Insert multiple times for multiple splits
    split_ratio: the test and valid set ratio
    """

    df = pd.read_csv(input_csv_file)
    for s in seed:
        test_df = df.sample(frac=split_ratio, random_state=s)
        train_valid_df = df.drop(test_df.index)
        valid_df = train_valid_df.sample(frac=split_ratio, random_state=s)
        train_df = train_valid_df.drop(valid_df.index)

        # Save the new dataframes to output_path/random${seed}
        try:
            os.makedirs(os.path.join(output_path, f"random{s}"))
        except:
            print('The folder is already present, overwriting')

        test_df.to_csv(os.path.join(output_path, f"random{s}/df.test.csv"), index=False)
        train_valid_df.to_csv(os.path.join(output_path, f"random{s}/df.train_valid.csv"), index=False)
        valid_df.to_csv(os.path.join(output_path, f"random{s}/df.valid.csv"), index=False)
        train_df.to_csv(os.path.join(output_path, f"random{s}/df.train.csv"), index=False)

if __name__ == "__main__":
    main()
